{% extends "base.html" %}
{% load static %}
{% load custom_tags %}
{% load toolbox_tags %}
{% if form|has_geometry_field %}
  {% load leaflet_tags %}
{% endif %}

{% block style %}
  <!-- inherits from form.html -->
  {{ block.super }}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
  {% if form|has_geometry_field %}
    {% leaflet_css plugins="geoman,locatecontrol,nontiledlayer" %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/form-map.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'kiju/css/form.css' %}">
  {% endif %}
{% endblock %}

{% block scripts %}
  <!-- inherits from form.html -->
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  {% if form|has_geometry_field %}
    {% leaflet_js plugins="geoman,locatecontrol" %}
    <script src="{% static 'proj4/proj4.js' %}"></script>
    <script src="{% static 'wicket/wicket.js' %}"></script>
    <script src="{% static 'wicket/wicket-leaflet.js' %}"></script>
    <script src="{% static 'proj4leaflet/proj4leaflet.js' %}"></script>
    <script src="{% static 'datenmanagement/js/cartographicHelpers.js' %}"></script>
    <script src="{% static 'datenmanagement/js/genericHelpers.js' %}"></script>
    <script type="module" src="{% static 'datenmanagement/js/leafletHelpers.js' %}"></script>
  {% endif %}
{% endblock %}

{% block title %}KiJu | {% endblock %}

{% block content %}
  <div class="container-xxl">
    {% if is_update %}
      <a href="{% dynamic_url model_lower 'list' %}">
        <i class="fa-solid fa-angle-left me"></i>
        Zurück zur Übersicht
      </a>
    {% else %}
      <a href="{% url 'kiju:index' %}">
        <i class="fa-solid fa-angle-left me"></i>
        Zurück zum KiJu-Dashboard
      </a>
    {% endif %}
    <h1 class="mb-4">
      {% if is_update %}
        {{ model_verbose_name|default:model_name }} bearbeiten
      {% else %}
        {{ model_verbose_name|default:model_name }} hinzufügen
      {% endif %}
    </h1>
    <form class="form mt-4 {% if form|has_geometry_field %}flex-container-row{% else %}flex-container-column{% endif %}" action="" method="post" id="form">
      {% csrf_token %}
      {% if form|has_geometry_field %}
        <div class="flex-item flex-container-column" id="flex-left">
      {% endif %}
      <div class="flex-item" id="flex-list">
        <div {% if form|has_geometry_field %}id="custom-form"{% endif %}>
          <table class="table">
        <tbody>
          {% for field in form %}
            {#{% if not field|is_field_geometry_field %}#}
              <tr>
                <td>
                  {% if field.field.required %}
                    <strong>{{ field.label_tag }}</strong>
                  {% else %}
                    {{ field.label_tag }}
                  {% endif %}
                </td>
                <td>
                  {% if field.name == 'paragraph' %}
                    <div class="input-group">
                      <span class="input-group-text">§</span>
                      {{ field }}
                    </div>
                  {% elif field.name == 'costs' %}
                    <div class="input-group">
                      <span class="input-group-text">€</span>
                      {{ field }}
                    </div>
                  {% elif field.type == 'file' %}
                    <div class="input-group">
                      <label class="input-group-text" for="{{ field.id }}">Upload</label>
                      {{ field }}
                    </div>
                  {% elif field|is_field_geometry_field %}
                    <div id="map-addresssearch-container-form">
                      <label hidden for="id_geometrie" class="form-label">{{ field.label }}</label>
                      {% if geometry %}
                        <textarea hidden id="id_geometrie" class="required django-leaflet-raw-textarea" name="{{ field.name }}" cols="150" rows="4">{{ geometry }}</textarea>
                      {% else %}
                        <textarea hidden id="id_geometrie" class="required django-leaflet-raw-textarea" name="{{ field.name }}" cols="150" rows="4">{ "type": "Point", "coordinates": [] }</textarea>
                      {% endif %}
                      {% leaflet_map "leaflet-map" callback="window.mapCallbackFunction" %}
                    </div>
                    <div class="" id="flex-address-search">
                      <div class="d-grid mt-3 g-2">
                        <div class="row row-cols-2 g-2">
                          <div class="col d-grid">
                            <button disabled id="addressToMap" class="btn btn-primary col" type="button"><i class="fas fa-map-marker-alt"></i> Marker auf Adresse setzen</button>
                          </div>
                          <div class="col d-grid">
                            <button disabled id="mapToAddress" class="btn btn-primaryc col" type="button"><i class="fas fa-home"></i> Adresse aus Karte übernehmen</button>
                          </div>
                        </div>
                      </div>
                      <div class="mt-3">
                        <label for="id_address" class="form-label">Adresse</label>
                        <div class="form-floating">
                          <input id="id_address" type="text" class="form-control" name="address" autocapitalize="off" autocomplete="off" placeholder="Adresse suchen…">
                          <label for="id_address">Adresse suchen…</label>
                        </div>
                        <div id="results-container" class="results dropdown-menu"></div>
                      </div>
                    </div>
                  {% else %}
                    {{ field }}
                  {% endif %}
                </td>
                {% if field.errors %}
                <td>
                  {{ field.errors }}
                </td>
                {% endif %}
              </tr>
            {#{% endif %}#}
          {% endfor %}
        </tbody>
      </table>
        </div>
      </div>
      <div class="flex-item" id="flex-action-buttons">
        <div id="form-control-buttons" class="mt-3 mb-3">
          <button type="submit" class="btn btn-primary" {% if form|has_geometry_field %}onclick="setFinalGeometry('#id_geometrie');"{% endif %}>{{ model_verbose_name }} speichern</button>
          {% if is_update %}
            <button type="button" class="btn btn-outline-danger me-2" data-bs-toggle="modal" data-bs-target="#deleteModal" data-object-id="{{ object.pk }}" data-object-name="{{ object }}" data-model-name="{{ model_verbose_name|default:model_name }}" data-model-lower="{{ model_lower }}" data-delete-url="{% dynamic_url model_lower 'delete' object.pk %}" data-list-url="{% dynamic_url model_lower 'list' %}" data-object-data='{{ object|to_json }}'>
              <i class="fa-solid fa-trash me-1"></i>
              Löschen
            </button>
          {% endif %}
          <a href="{% dynamic_url model_lower 'list' %}" class="btn btn-outline-secondary">Abbrechen</a>
        </div>
      </div>
    </form>
    {% if form|has_geometry_field %}
      <script>
        /**
         * @function
         * @name mapCallbackFunction
         *
         * handles (as a callback function) passed map
         *
         * @param {Object} map - map
         */
        function mapCallbackFunction(map) {
          setMapConstants(map, {{ LEAFLET.MAX_ZOOM }});
          configureMap(map, '{% url "toolbox:owsproxy" %}');

          // make map globally available
          window.currMap = map;

          // configure globally available markers for Leaflet
          window.redMarker = new L.Icon({
            shadowUrl: '{% static "datenmanagement/img/leaflet-markers/marker-shadow.png" %}',
            iconUrl: '{% static "datenmanagement/img/leaflet-markers/marker-red.svg" %}',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
          });

          // define several globally available variables
          window.featureGeometry = [];
          window.geometryType = '{{ model_geometry_type }}';

          configureLeafletGeoman(map, 'Point');

          // show existing geometry on map
          console.log("run map.loadGeometryFromField('#id_geometrie')")
          map.loadGeometryFromField('#id_geometrie')
          console.log("geometry loaded.")


          /**
           * @function
           *
           * checks (on starting "sketching" mode) if a Leaflet-Geoman layer already exists
           * and deletes it if necessary
           */
          map.on('pm:drawstart', function () {
            if (map.pm.getGeomanLayers().length > 0) {
              map.pm.getGeomanLayers().forEach((item) => {
                if ('_drawnByGeoman' in item && item._drawnByGeoman === true)
                  map.removeLayer(item);
              })
            }
          });

          /**
           * @function
           *
           * enables (on creating a Leaflet-Geoman layer) address reference button
           */
          map.on('pm:create', function () {
            enableAddressReferenceButton();
          });
        }

        /**
         * @function
         *
         * main function
         */
        document.addEventListener('DOMContentLoaded', function() {

          // initialize address search (and make its results globally available)
          window.results = document.querySelector('div.results');
          window.addressType = 'Adresse';
          window.searchField = document.getElementById('id_address');
          initializeAddressSearch(window.searchField, '{% url "toolbox:addresssearch" %}', window.addressType);

          // on clicking the map reference (i.e. address to map) button...
          const addressToMapButton = document.getElementById('addressToMap');
          if (addressToMapButton) {
            addressToMapButton.addEventListener('click', function () {
              setMarkerToAddressSearchResult(window.currMap);
              enableAddressReferenceButton();
            });
          }

          // on clicking the address reference (i.e. map to address) button...
          const mapToAddressButton = document.getElementById('mapToAddress');
          if (mapToAddressButton) {
            mapToAddressButton.addEventListener('click', function () {
              setAddressToMarkerAddress(window.currMap.pm.getGeomanLayers()[0], '{% url "toolbox:reversesearch" %}');
              const addressToMapBtn = document.getElementById('addressToMap');
              if (addressToMapBtn) {
                addressToMapBtn.disabled = false;
              }
            });
          }
        });

      </script>
    {% endif %}
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // initialize all multi-select-fields with select2
        const select2Elements = document.querySelectorAll('.select2-multiple');
        select2Elements.forEach(function(element) {
          $(element).select2({
            theme: "bootstrap-5",
            width: element.dataset.width ? element.dataset.width : element.classList.contains('w-100') ? '100%' : 'style',
            placeholder: element.dataset.placeholder || 'Bitte wählen...',
            closeOnSelect: false,
            allowClear: true
          });
        });
      });
    </script>
  </div>
  <script src="{% static 'js/form.js' %}"></script>

  <!-- Löschen-Modal -->
  {% include "kiju/includes/delete_modal.html" %}
{% endblock %}
