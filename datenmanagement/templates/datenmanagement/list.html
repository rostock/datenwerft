{% extends 'navbar.html' %}
{% load datenmanagement_tags %}
{% load static %}

{% block title %}{{ model_verbose_name_plural }} – Tabelle | {% endblock %}

{% block style %}
  {{ block.super }}
  <link rel="stylesheet" type="text/css" href="{% static 'datatables/datatables.min.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'datenmanagement/css/list.css' %}">
{% endblock %}

{% block scripts %}
  {{ block.super }}
  <script src="{% static 'datatables/datatables.min.js' %}"></script>
  <script src="{% static 'datenmanagement/js/genericHelpers.js' %}"></script>
  <script src="{% static 'datenmanagement/js/subsetting.js' %}"></script>
{% endblock %}

{% block content %}
  <h2>{{ model_verbose_name_plural }}</h2>
  <h4><small>{{ model_description }}</small></h4>
  <h4 class="mt-3">
    <em>
      {% if objects_count > 0 %}
        Liste aller Datensätze
      {% else %}
        Keine Datensätze vorhanden!
      {% endif %}
    </em>
  </h4>
  <div class="d-grid gap-2{% if not request.user_agent.is_mobile and not request.user_agent.is_tablet %} d-md-block{% endif %}">
    {% if editable and user|user_has_model_add_permission:model_name_lower %}
      <a class="btn btn-primary" role="button" href="{% url 'datenmanagement:'|add:model_name|add:'_add' %}"><i class="fas fa-circle-plus"></i> neuen Datensatz anlegen</a>
    {% endif %}
    {% if objects_count > 0 and geometry_type %}
      <a class="btn btn-secondary" role="button" href="{% url 'datenmanagement:'|add:model_name|add:'_map' %}"><i class="fas fa-map"></i> alle Datensätze auf Karte anzeigen</a>
      <button id="subsetter" class="btn btn-secondary"><i class="fas fa-map"></i> <i class="fas fa-filter"></i> aktuelle Filtermenge auf Karte übernehmen</button>
    {% endif %}
    <a class="btn btn-warning" role="button" href="{% url 'datenmanagement:'|add:model_name|add:'_start' %}"><i class="fas fa-backward"></i> zurück</a>
  </div>
  {% if objects_count > 0 %}
    <div class="d-grid mt-5{% if not editable or not user|user_has_model_delete_permission:model_name_lower %} mb-3{% endif %} gap-2 mx-auto">
      {% if subset_id %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="fa-solid fa-triangle-exclamation"></i> Es werden <strong><em>nicht alle</em></strong> Datensätze in der Tabelle gelistet, sondern nur die <strong><em>aus der Karte übernommenen</em></strong> Datensätze!
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endif %}
      <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <i class="fa-solid fa-triangle-exclamation"></i> Tabelle wird Server-seitig erzeugt, weshalb nur die <strong><em>aktuell sichtbare</em></strong> Tabelle exportiert wird – Anzahl der aktuell sichtbaren Datensätze unten links steuerbar
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
      <table id="datasets" class="table table-bordered table-striped">
        <thead>
          <tr>
            <th class="no-export"><i class="fas fa-check-square"></i></th>
            {% for label in list_fields_labels %}
              {% with schritt=forloop.counter|stringformat:'s' %}
                {% with spalte='spalte_'|add:schritt %}
                  <th>{{ label }}</th>
                {% endwith %}
              {% endwith %}
            {% endfor %}
            {% if editable %}
              {% if user|user_has_model_view_permission:model_name_lower or user|user_has_model_change_permission:model_name_lower %}
                <th class="no-export"><i class="fas fa-eye" title="Datensätze ansehen"></i> oder <i class="fas fa-edit" title="Datensätze bearbeiten"></i></th>
              {% endif %}
              {% if user|user_has_model_delete_permission:model_name_lower %}
                <th class="no-export"><i class="fas fa-trash" title="Datensätze löschen"></i></th>
              {% endif %}
            {% endif %}
          </tr>
        </thead>
      </table>
      <!-- eslint-disable-next-script -->
      <script>
        {% if subset_id %}
          window.dataUrl = "{% url 'datenmanagement:'|add:model_name|add:'_data'|add:'_subset' subset_id %}";
        {% else %}
          window.dataUrl = "{% url 'datenmanagement:'|add:model_name|add:'_data' %}";
        {% endif %}
        window.languageUrl = '{% static 'datatables/datatables.german.lang' %}';
      </script>
      <script>
        /* global $, jQuery, subsetting */
        /* eslint no-undef: "error" */

        /**
         * @function
         *
         * Hauptfunktion
         */
        $(document).ready(function() {
          let table = $('#datasets').DataTable({
            ajax: window.dataUrl,
            buttons: [
              {
                extend: 'csvHtml5',
                fieldSeparator: ';',
                exportOptions: {
                  // entsprechend markierte Spalten nicht exportieren
                  columns: ':visible:not(.no-export)',
                }
              }, {
                extend: 'excelHtml5',
                title: '',
                exportOptions: {
                  // entsprechend markierte Spalten nicht exportieren
                  columns: ':visible:not(.no-export)',
                }
              }, {
                extend: 'pdfHtml5',
                orientation: 'landscape',
                pageSize: 'A4',
                exportOptions: {
                  // entsprechend markierte Spalten nicht exportieren
                  columns: ':visible:not(.no-export)',
                },
                customize: function(doc) {
                  doc.defaultStyle.fontSize = 7;
                  doc.pageMargins = [20, 20, 20, 20];
                  doc.styles.tableHeader.fontSize = 7;
                }
              }
            ],
            colReorder: true,
            columnDefs: determineColumnDefs(
                '{{ editable }}',
                '{{ user|user_has_model_view_permission:model_name_lower }}',
                '{{ user|user_has_model_change_permission:model_name_lower }}',
                '{{ user|user_has_model_delete_permission:model_name_lower }}'
            ),
            createdRow: function(row) {
              // inaktive Zeilen (= Datensätze) mit schwächerer Textfarbe versehen
              if ($(row).find('td:nth-child(2)').text() === 'nein') {
                $(row).addClass('text-secondary');
              // entsprechend markierte Zeilen (= Datensätze) mit besonderer Textfarbe hervorheben
              } else if ($(row).find('.text-danger').length) {
                $(row).addClass('text-danger');
              }
            },
            dom: '<Bfr<t>ilp>',
            fixedHeader: true,
            language: {
              url: window.languageUrl
            },
            lengthMenu: [[25, 50, -1], [25, 50, 'alle']],
            orderCellsTop: true,
            orderClasses: false,
            orderMulti: false,
            pageLength: 25,
            processing: true,
            searchDelay: 500,
            searching: true,
            serverSide: true,
            stateSave: true
          });

          // bei Klick auf Button zum Ausführen der gewählten Aktion...
          $('#action-button').click(function() {
            // falls gewählte Aktion das Löschen ausgewählter Datensätze ist...
            if ($('#action-select').val() === 'delete-selected') {
              let actionCheckboxes = $('.action-checkbox').filter(':checked');
              if (actionCheckboxes.length > 0) {
                // alle ausgewählten Zeilen (= Datensätze) durchgehen...
                actionCheckboxes.each(function() {
                  // Zeile (= Datensatz) löschen
                  let id = $(this).val();
                  {% with tmp='worschdsupp' %}
                    let url_mask = "{% url 'datenmanagement:'|add:model_name|add:'_deleteimmediately' tmp %}".replace(/worschdsupp/, id.toString());
                  {% endwith %}
                  jQuery.get(url_mask);
                });
                // kurz warten und Tabelle neuladen, damit gelöschte Zeilen (= Datensätze) verschwinden
                setTimeout(function() {
                  table.ajax.reload();
                  $('#action-count').text('kein Datensatz');
                }, 1000);
              }
            }
          });

          // bei Klick auf Button zur Übergabe der aktuellen Filtermenge an Kartenansicht...
          $('#subsetter').on('click', function() {
            // Primärschlüssel aller Objekte in aktueller Filtermenge sammeln
            let currentTablePrimaryKeys = [];
            let tableData = table.rows().data();
            for (let i = 0; i < tableData.length; i++) {
              let stringWithPrimaryKeys = tableData[i][0];
              currentTablePrimaryKeys.push(stringWithPrimaryKeys.replace(/.*value="/, '').replace(/">/, ''));
            }
            // Filtermenge behandeln und übergeben
            {% with tmp='worschdsupp' %}
              let url_mask = "{% url 'datenmanagement:'|add:model_name|add:'_map'|add:'_subset' tmp %}";
            {% endwith %}
            subsetting(
              currentTablePrimaryKeys,
              '{% url "toolbox:subset_add" %}',
              '{{ model_name }}',
              '{{ model_pk_field }}',
              url_mask,
              'Bei der Übernahme der aktuellen Filtermenge auf die Karte ist ein Serverfehler aufgetreten.'
            );
          });
        });

        // sobald eine Zeile (= Datensatz) an- oder abgewählt wurde...
        $('body').on('change', '.action-checkbox', function() {
          let actionCheckboxes = $('.action-checkbox').filter(':checked');
          // Hinweistexte entsprechend anpassen
          if (actionCheckboxes.length === 1)
            $('#action-count').text('1 Datensatz ausgewählt');
          else if (actionCheckboxes.length === 0)
            $('#action-count').text('kein Datensatz ausgewählt');
          else
            $('#action-count').text(actionCheckboxes.length + ' Datensätze ausgewählt');
        });

        /**
         * @function
         * @name cloneObject
         *
         * legt die Spaltendefinition fest
         *
         * @param {String} editable - Datenmodell generell bearbeitbar?
         * @param {String} viewPerm - Recht zum Ansehen von Datenobjekten im Datenmodell vorhanden?
         * @param {String} changePerm - Recht zum Ändern von Datenobjekten im Datenmodell vorhanden?
         * @param {String} deletePerm - Recht zum Löschen von Datenobjekten im Datenmodell vorhanden?
         * @returns {Object[]} - Spaltendefinition
         */
        function determineColumnDefs(editable, viewPerm, changePerm, deletePerm) {
          let columnDefs = [{
            'orderable': false,
            'targets': 0
          }];
          if (editable.toLowerCase() === 'true') {
            let furtherColumnDefs = [];
            if (viewPerm.toLowerCase() === 'true' || changePerm.toLowerCase() === 'true') {
              if (deletePerm.toLowerCase() === 'true')
                furtherColumnDefs = [{
                  'orderable': false,
                  'targets': -2
                }, {
                  'orderable': false,
                  'targets': -1
                }];
              else
                furtherColumnDefs = [{
                    'orderable': false,
                    'targets': -1
                  }];
            } else if (deletePerm.toLowerCase() === 'true')
              furtherColumnDefs = [{
                  'orderable': false,
                  'targets': -1
                }];
            return columnDefs.concat(furtherColumnDefs);
          } else
            return columnDefs;
        }
      </script>
    </div>
    {% if editable and user|user_has_model_delete_permission:model_name_lower %}
      <div class="d-grid mt-4">
        <span id="action-count">kein Datensatz ausgewählt</span>
      </div>
      <div class="d-grid mt-2 mb-3">
        <div class="input-group">
          <select class="form-select" id="action-select" name="action">
            <option selected>Aktion wählen…</option>
            <option value="delete-selected">ausgewählte Datensätze löschen</option>
          </select>
          <button id="action-button" class="btn btn-danger" type="button">Aktion ausführen</button>
        </div>
      </div>
    {% endif %}
    {% include "modal-error.html" %}
  {% endif %}
{% endblock %}
